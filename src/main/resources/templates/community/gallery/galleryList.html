<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>EnLink - ëª¨ì„ ì‚¬ì§„ì²©</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* ê°¤ëŸ¬ë¦¬ ì „ìš© ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
      .gallery-img {
        width: 100%;
        height: 250px; /* ê³ ì • ë†’ì´ */
        object-fit: cover; /* ì‚¬ì§„ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
        cursor: pointer;
        transition: transform 0.2s;
      }
      .gallery-img:hover {
        transform: scale(1.02); /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ */
        opacity: 0.9;
      }
      .card {
        overflow: hidden;
        border: none;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom"
      >
        <h2 class="fw-bold">ğŸ“¸ ëª¨ì„ ì‚¬ì§„ì²©</h2>
        <button
          class="btn btn-primary px-4"
          data-bs-toggle="modal"
          data-bs-target="#uploadModal"
        >
          ì‚¬ì§„ ì˜¬ë¦¬ê¸°
        </button>
      </div>

      <div
        class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4"
        id="galleryContainer"
      ></div>

      <div class="text-center mt-5 mb-5">
        <button
          id="moreBtn"
          class="btn btn-outline-primary btn-lg px-5"
          onclick="loadPhotos()"
        >
          ë”ë³´ê¸°
        </button>
      </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">
          <div class="modal-body p-0 text-center bg-dark">
            <img
              src=""
              id="modalImg"
              class="img-fluid"
              style="max-height: 80vh"
            />
          </div>
          <div class="modal-footer justify-content-between bg-white">
            <div id="modalInfo" class="small text-muted text-start"></div>
            <div>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                data-bs-dismiss="modal"
              >
                ë‹«ê¸°
              </button>
              <button
                type="button"
                class="btn btn-danger btn-sm"
                id="deleteBtn"
                style="display: none"
              >
                ì‚­ì œ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ìƒˆ ì‚¬ì§„ ì—…ë¡œë“œ</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="imageFile" class="form-label text-muted small"
                >ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</label
              >
              <input
                type="file"
                id="imageFile"
                class="form-control"
                accept="image/*"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="uploadPhoto()"
            >
              ì—…ë¡œë“œ ì‹œì‘
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
      /* íƒ€ì„ë¦¬í”„ë¡œë¶€í„° ë„˜ê²¨ë°›ì€ ë³€ìˆ˜ ì„¤ì • */
      const clubId = /*[[${club.clubId}]]*/ 0; // Controllerì—ì„œ Modelì— ë‹´ì•„ì¤€ club ê°ì²´ í™œìš©
      let currentPage = 0;

      $(document).ready(function () {
        // ì²˜ìŒ í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ í˜ì´ì§€ ì‚¬ì§„ë“¤ ê°€ì ¸ì˜¤ê¸°
        loadPhotos();
      });

      // 1. ì‚¬ì§„ ëª©ë¡ ë¡œë“œ (Ajax)
      function loadPhotos() {
        $.ajax({
          url: `/api/gallery/${clubId}?page=${currentPage}`,
          type: 'GET',
          success: function (page) {
            const photos = page.content;
            let html = '';

            if (photos.length === 0 && currentPage === 0) {
              $('#galleryContainer').html(
                '<div class="col-12 text-center py-5 text-muted">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>',
              );
              $('#moreBtn').hide();
              return;
            }

            photos.forEach((photo) => {
              html += `
                  <div class="col">
                      <div class="card h-100 shadow-sm">
                          <img src="/galleryImg/${photo.imageUrl}" class="gallery-img"
                                onclick="showDetail(${photo.photoId}, '${photo.imageUrl}', '${photo.memberId}', '${photo.createdAt}')">
                      </div>
                  </div>`;
            });

            $('#galleryContainer').append(html);

            // ë§ˆì§€ë§‰ í˜ì´ì§€ë©´ 'ë”ë³´ê¸°' ë²„íŠ¼ ì œê±°
            if (page.last) {
              $('#moreBtn').hide();
            } else {
              currentPage++;
            }
          },
          error: function () {
            alert('ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          },
        });
      }

      // 2. ì‚¬ì§„ ì—…ë¡œë“œ
      function uploadPhoto() {
        const fileInput = document.getElementById('imageFile');
        if (!fileInput.files[0]) {
          alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('clubId', clubId);

        $.ajax({
          url: '/api/gallery/upload',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function () {
            alert('ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ìµœì‹  ì‚¬ì§„ í™•ì¸
          },
          error: function (err) {
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.responseText);
          },
        });
      }

      // 3. ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ ë„ìš°ê¸°
      function showDetail(photoId, url, author, date) {
        // ë‚ ì§œ í˜•ì‹ ì˜ˆì˜ê²Œ ë³€í™˜ (T ë¶„ë¦¬)
        const formattedDate = date.replace('T', ' ').split('.')[0];

        $('#modalImg').attr('src', '/galleryImg/' + url);
        $('#modalInfo').html(
          `<strong>ë“±ë¡ì:</strong> ${author}<br><strong>ë“±ë¡ì¼:</strong> ${formattedDate}`,
        );

        // ì‚­ì œ ë²„íŠ¼ì— í•´ë‹¹ ì‚¬ì§„ì˜ IDë¥¼ ì €ì¥í•˜ê³  ë³´ì´ê²Œ ì„¤ì •
        $('#deleteBtn')
          .show()
          .off('click')
          .on('click', function () {
            deletePhoto(photoId);
          });

        // ìƒì„¸ ëª¨ë‹¬ ì˜¤í”ˆ
        const detailModal = new bootstrap.Modal(
          document.getElementById('detailModal'),
        );
        detailModal.show();
      }

      // 4. ì‚¬ì§„ ì‚­ì œ (Ajax)
      function deletePhoto(photoId) {
        if (!confirm('ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        $.ajax({
          url: `/api/gallery/${photoId}`,
          type: 'DELETE',
          success: function (response) {
            alert(response);
            location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨
          },
          error: function (err) {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.responseText);
          },
        });
      }
    </script>
  </body>
</html>
