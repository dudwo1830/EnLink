<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>ëª¨ì„ ê²Œì‹œê¸€ ëª©ë¡</h1>

    <div style="margin-bottom: 10px; text-align: right">
      <button
        type="button"
        onclick="location.href = '/post/write'"
        style="
          padding: 10px 20px;
          cursor: pointer;
          background-color: #4caf50;
          color: white;
          border: none;
          border-radius: 4px;
        "
      >
        ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°
      </button>
    </div>

    <div class="search-area" style="margin-bottom: 20px; text-align: center">
      <form
        th:action="@{/post/list}"
        method="get"
        style="display: inline-block"
      >
        <input type="hidden" name="clubId" th:value="${clubId}" />

        <select name="searchType" id="searchType" style="padding: 5px">
          <option
            value="all"
            th:selected="${searchType == 'all' or searchType == null}"
          >
            ì œëª©+ë‚´ìš©
          </option>
          <option value="title" th:selected="${searchType == 'title'}">
            ì œëª©
          </option>
          <option value="content" th:selected="${searchType == 'content'}">
            ë‚´ìš©
          </option>
        </select>

        <input
          type="text"
          name="searchKeyword"
          th:value="${searchKeyword}"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          style="padding: 5px; width: 250px"
        />

        <button type="submit" style="padding: 5px 15px">ê²€ìƒ‰</button>

        <a
          th:href="@{/post/list(clubId=${clubId})}"
          style="
            text-decoration: none;
            font-size: 0.9em;
            color: gray;
            margin-left: 10px;
          "
        >
          ì´ˆê¸°í™”
        </a>
      </form>
    </div>

    <table>
      <thead>
        <tr>
          <th>ë²ˆí˜¸</th>
          <th>ì œëª©</th>
          <th>ì‘ì„±ì</th>
          <th>ì‘ì„±ì¼</th>
        </tr>
      </thead>
      <tbody id="post-list"></tbody>
    </table>
    <div id="pagination" style="text-align: center; margin-top: 20px"></div>

    <script>
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener('DOMContentLoaded', function () {
        loadPage();
      });

      // 1. URLì—ì„œ íŒŒë¼ë¯¸í„°(clubId, searchType, searchKeyword) ëª¨ë‘ ì¶”ì¶œ
      function loadPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const clubId = urlParams.get('clubId') || 1;
        const searchType = urlParams.get('searchType') || 'all';
        const searchKeyword = urlParams.get('searchKeyword') || '';
        const page = urlParams.get('page') || 0; // í˜ì´ì§€ ë²ˆí˜¸ ì½ê¸° (ê¸°ë³¸ê°’ 0)

        // 2. ì¶”ì¶œí•œ ê°’ìœ¼ë¡œ ë°ì´í„° ìš”ì²­
        fetchPosts(clubId, searchType, searchKeyword, page);
      }

      function fetchPosts(clubId, searchType, searchKeyword, page) {
        // URL ìƒì„± (API ì£¼ì†Œì— searchType, searchKeyword, pageë¥¼ ëª¨ë‘ í¬í•¨)
        let fetchUrl = `/api/posts?clubId=${clubId}&searchType=${searchType}&page=${page}`;

        if (searchKeyword) {
          fetchUrl += `&searchKeyword=${encodeURIComponent(searchKeyword)}`;
        }

        // ë°˜ë“œì‹œ ìœ„ì—ì„œ ë§Œë“  'fetchUrl' ë³€ìˆ˜ë¥¼ ì‚¬ìš©
        fetch(fetchUrl)
          .then((response) => response.json())
          .then((data) => {
            // [ì¤‘ìš”] ì´ì œ ë°ì´í„°ëŠ” data ìì²´ê°€ ì•„ë‹ˆë¼ data.contentì— ë“¤ì–´ìˆìŠµë‹ˆë‹¤.
            renderPostList(data.content);
            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ê·¸ë¦¬ê¸°
            renderPagination(data, clubId, searchType, searchKeyword);
          })
          .catch((error) => console.error('Error:', error));
      }

      // ê²Œì‹œê¸€ ëª©ë¡ ë Œë”ë§
      function renderPostList(posts) {
        const listElement = document.getElementById('post-list');
        listElement.innerHTML = '';

        if (!posts || posts.length === 0) {
          listElement.innerHTML =
            '<tr><td colspan="4" style="text-align:center;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        posts.forEach((post) => {
          const noticeTag = post.isNotice
            ? '<b style="color:red;">[ê³µì§€] </b>'
            : '';
          const date = post.createdAt ? post.createdAt.split('T')[0] : '-';
          const row = `<tr>
            <td>${post.isNotice ? 'ğŸ“¢' : post.postId}</td>
            <td>${noticeTag}<a href="/post/detail/${post.postId}">${post.title}</a></td>
            <td>${post.memberId}</td>
            <td>${date}</td>
        </tr>`;
          listElement.innerHTML += row;
        });
      }

      // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë Œë”ë§
      function renderPagination(pageData, clubId, searchType, searchKeyword) {
        const paginationElement = document.getElementById('pagination'); // HTMLì— ì´ IDë¥¼ ê°€ì§„ divê°€ í•„ìš”í•©ë‹ˆë‹¤.
        paginationElement.innerHTML = '';

        const totalPages = pageData.totalPages;
        const currentPage = pageData.number;

        for (let i = 0; i < totalPages; i++) {
          const btn = document.createElement('button');
          btn.innerText = i + 1;
          btn.style.margin = '0 5px';
          btn.style.padding = '5px 10px';

          // í˜„ì¬ í˜ì´ì§€ ë²„íŠ¼ ê°•ì¡°
          if (i === currentPage) {
            btn.style.backgroundColor = '#007bff';
            btn.style.color = 'white';
          }

          btn.onclick = function () {
            // í´ë¦­ ì‹œ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™ (URL íŒŒë¼ë¯¸í„° ë³€ê²½)
            location.href = `/post/list?clubId=${clubId}&searchType=${searchType}&searchKeyword=${searchKeyword}&page=${i}`;
          };
          paginationElement.appendChild(btn);
        }
      }
    </script>
  </body>
</html>
