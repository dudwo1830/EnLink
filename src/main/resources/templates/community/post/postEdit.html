<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>게시글 수정</title>
  </head>
  <body>
    <h1>게시글 수정하기</h1>
    <form id="editForm">
      <label for="title">제목</label><br />
      <input
        type="text"
        id="title"
        style="width: 100%; padding: 10px"
        required
      /><br /><br />

      <label for="content">내용</label><br />
      <textarea id="content" rows="10" style="width: 100%" required></textarea
      ><br /><br />

      <label>이미지 수정 (변경하려면 선택하세요)</label><br />
      <input
        type="file"
        id="imageFile"
        accept="image/*"
        onchange="previewImage(this)"
      /><br />
      <div id="imagePreviewContainer" style="margin-top: 10px">
        <img id="preview" src="" style="max-width: 300px; border-radius: 5px" />
        <p id="noImageText" style="color: gray; display: none">
          등록된 이미지가 없습니다.
        </p>
      </div>
      <br />

      <button type="button" onclick="updatePost()">수정 완료</button>
      <button type="button" onclick="history.back()">취소</button>
    </form>

    <script th:inline="javascript">
      // 1. 타임리프 바구니에서 postId(글 번호)를 꺼내서 자바스크립트 변수에 담습니다.
      const postId = /*[[${postId}]]*/ 0;

      // 2. 페이지가 열리자마자 "기존 글 내용"을 서버에서 가져와서 빈칸에 채워넣습니다.
      document.addEventListener('DOMContentLoaded', function () {
        fetchExistingPost();
      });

      function fetchExistingPost() {
        // 상세조회 API와 똑같은 주소를 사용합니다.
        fetch(`/api/posts/${postId}`)
          .then((response) => response.json())
          .then((post) => {
            // 서버에서 받은 데이터를 입력창(input, textarea)에 쏙 집어넣습니다.
            document.getElementById('title').value = post.title;
            document.getElementById('content').value = post.content;

            // 기존 이미지가 있다면 미리보기에 표시
            if (post.imageUrl) {
              const preview = document.getElementById('preview');
              preview.src = `/images/${post.imageUrl}`;
              document.getElementById('imagePreviewContainer').style.display =
                'block';
            }
          })
          .catch((error) => alert('기존 내용을 불러오지 못했습니다.'));
      }

      // 파일 선택 시 미리보기 변경 로직
      function previewImage(input) {
        const preview = document.getElementById('preview');
        const container = document.getElementById('imagePreviewContainer');
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.src = e.target.result;
            container.style.display = 'block';
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. 사용자가 내용을 다 고치고 [수정 완료]를 눌렀을 때 실행됩니다.
      function updatePost() {
        // 서버의 PostDTO 필드 이름과 똑같이 맞춥니다. 이미지가 포함될 수 있으므로 FormData를 사용.
        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('content', document.getElementById('content').value);
        
        const fileInput = document.getElementById('imageFile');
        if (fileInput.files[0]) {
            formData.append('image', fileInput.files[0]); // DTO의 필드명 'image'
        }
        
        fetch(`/api/posts/${postId}`, {
          method: 'PUT',
            // headers에 Content-Type을 절대 넣지 말 것 (FormData가 알아서 설정함)
            body: formData
        })
          .then((response) => {
            if (response.ok) {
              alert('성공적으로 수정되었습니다!');
              location.href = `/community/post/detail/${postId}`;
            } else {
              alert('수정 실패!');
            }
          })
          .catch((error) => console.error('Error:', error));
      }
    </script>
  </body>
</html>
