<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>ëª¨ì„ ì¼ì •</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom"
      >
        <h2 class="fw-bold">ğŸ“… ëª¨ì„ ì¼ì •</h2>
        <div id="adminCreateArea" style="display: none">
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#createScheduleModal"
          >
            ì¼ì • ì¶”ê°€
          </button>
        </div>
      </div>

      <div id="scheduleContainer" class="row row-cols-1 g-4">
        <div class="col text-center py-5 text-muted">
          ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì¼ì •ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”!
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="createScheduleModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">ìƒˆ ì¼ì • ë“±ë¡</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="title" class="form-label">ì¼ì • ì œëª©</label>
              <input
                type="text"
                id="title"
                class="form-control"
                placeholder="ì˜ˆ: ì •ê¸° ìŠ¤í„°ë”” ëª¨ì„"
              />
            </div>
            <div class="mb-3">
              <label for="eventDate" class="form-label">ì¼ì‹œ</label>
              <input
                type="datetime-local"
                id="eventDate"
                class="form-control"
              />
            </div>
            <div class="mb-3">
              <label for="location" class="form-label">ì¥ì†Œ</label>
              <input
                type="text"
                id="location"
                class="form-control"
                placeholder="ì˜ˆ: ê°•ë‚¨ì—­ ìŠ¤í„°ë””ë£¸"
              />
            </div>
            <div class="mb-3">
              <label for="maxCapa" class="form-label">ìµœëŒ€ ì •ì›</label>
              <input
                type="number"
                id="maxCapa"
                class="form-control"
                placeholder="ìˆ«ìë§Œ ì…ë ¥"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveSchedule()"
            >
              ì €ì¥í•˜ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="updateScheduleModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title fw-bold">ì¼ì • ìˆ˜ì •</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="updateSchedId" />
            <div class="mb-3">
              <label for="updateTitle" class="form-label">ì¼ì • ì œëª©</label>
              <input type="text" id="updateTitle" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="updateEventDate" class="form-label">ì¼ì‹œ</label>
              <input
                type="datetime-local"
                id="updateEventDate"
                class="form-control"
              />
            </div>
            <div class="mb-3">
              <label for="updateLocation" class="form-label">ì¥ì†Œ</label>
              <input type="text" id="updateLocation" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="updateMaxCapa" class="form-label">ìµœëŒ€ ì •ì›</label>
              <input type="number" id="updateMaxCapa" class="form-control" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="updateSchedule()"
            >
              ìˆ˜ì •ì™„ë£Œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ì°¸ì—¬ì ëª…ë‹¨ ëª¨ë‹¬ -->
    <div
      class="modal fade"
      id="participantModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title fw-bold">ğŸ‘¥ ì°¸ì—¬ì ëª…ë‹¨</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body p-0">
            <ul id="participantList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
      // íƒ€ì„ë¦¬í”„ë¡œë¶€í„° clubId ì „ë‹¬ë°›ê¸°
      const clubId = /*[[${clubId}]]*/ 0;

      // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹¤í–‰
      $(document).ready(function () {
        loadSchedules();
      });

      function exceptionTest() {
        $.ajax({
          url: '/api/schedule/test',
          type: 'GET',
          data: { clubId: clubId },
          success: function (list) {
            console.log('success');
            console.log(list);
          },
          error: function (err) {
            console.log('error');
            console.log(err);
            console.log(err.responseJSON);
            console.log(err.responseJSON.defaultMessage);
          },
        });
      }

      // 1. ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
      function loadSchedules() {
        $.ajax({
          url: '/api/schedule/list',
          type: 'GET',
          data: { clubId: clubId },
          success: function (list) {
            // ë¦¬ìŠ¤íŠ¸ê°€ ìˆê³ , ì²« ë²ˆì§¸ í•­ëª©ì´ ìš´ì˜ì§„ ê¶Œí•œ(isAdmin)ì„ ê°€ì§€ê³  ìˆë‹¤ë©´ ìƒë‹¨ ë²„íŠ¼ í‘œì‹œ
            if (list.length > 0 && list[0].admin) {
              // DTO í•„ë“œëª…ì´ adminì´ë¼ë©´ item.adminìœ¼ë¡œ ì ‘ê·¼
              $('#adminCreateArea').show(); // ìš´ì˜ì§„ì´ë©´ ë³´ì„
            } else {
              $('#adminCreateArea').hide(); // ì¼ë°˜ë©¤ë²„ë©´ ìˆ¨ê¹€
            }

            let html = '';
            if (list.length === 0) {
              html =
                '<div class="col text-center py-5 text-muted">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
              // ì„œë²„ì—ì„œ ë°›ì€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë³µë¬¸ìœ¼ë¡œ ëŒë ¤ ì¹´ë“œ ìƒì„±
              list.forEach(function (item) {
                // ìš´ì˜ì§„ì¼ ë•Œë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ HTML ìƒì„±
                let adminButtons = ''; // ê¸°ë³¸ì€ ë¹ˆì¹¸
                if (item.admin) {
                  // ì„œë²„ DTOì˜ isAdmin í•„ë“œê°’ì´ trueì¸ ê²½ìš°
                  adminButtons = `
                    <div>
                        <button class="btn btn-outline-warning btn-sm" onclick='openUpdateModal(${JSON.stringify(item)})'>ìˆ˜ì •</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSchedule(${item.schedId})">ì‚­ì œ</button>
                    </div>
                    `;
                }

                // ì°¸ê°€ ì‹ ì²­/ì·¨ì†Œ ë²„íŠ¼ ë¶„ê¸° ì²˜ë¦¬
                let actionButton = '';
                if (item.joined) {
                  // ì´ë¯¸ ì°¸ì—¬ ì¤‘ì´ë©´ ë¹¨ê°„ìƒ‰ ì·¨ì†Œ ë²„íŠ¼
                  actionButton = `<button class="btn btn-danger btn-sm w-100" onclick="cancelSchedule(${item.schedId})">ì°¸ê°€ ì·¨ì†Œ</button>`;
                } else {
                  // ì°¸ì—¬ ì „ì´ë©´ ì´ˆë¡ìƒ‰ ì‹ ì²­ ë²„íŠ¼
                  actionButton = `<button class="btn btn-outline-success btn-sm w-100" onclick="applySchedule(${item.schedId})">ì°¸ê°€ ì‹ ì²­</button>`;
                }

                html += `
            <div class="col">
              <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="card-title fw-bold text-primary mb-0">${item.title}</h5>
                  ${adminButtons} </div>
                <div class="card-body">
                  <p class="card-text mb-1">ğŸ“… <b>ì¼ì‹œ:</b> ${item.eventDate}</p>
                  <p class="card-text mb-1">ğŸ“ <b>ì¥ì†Œ:</b> ${item.location}</p>
                  <p class="card-text mb-3">
            ğŸ‘¥ <b>ì°¸ê°€ì¸ì›:</b> ${item.currentParticipants} / ${item.maxCapa}ëª…
            <a href="javascript:void(0)" class="ms-2 text-decoration-none small fw-bold text-info" 
               onclick="showParticipants(${item.schedId})">ëª…ë‹¨ë³´ê¸°</a>
          </p>
          ${actionButton} </div>
      </div>
    </div>`;
              });
            }
            // ëª©ë¡ ì»¨í…Œì´ë„ˆì— HTML ì£¼ì…
            $('#scheduleContainer').html(html);
          },
          error: function (err) {
            console.error('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
          },
        });
      }

      // 2. ì¼ì • ì €ì¥ í•¨ìˆ˜
      function saveSchedule() {
        console.log('ì €ì¥ ì‹œë„í•˜ëŠ” Club ID:', clubId);

        // 2-1. ë°ì´í„° ì¶”ì¶œ
        const title = $('#title').val();
        const rawDate = $('#eventDate').val(); // "2026-02-07T19:00" í˜•íƒœë¡œ ê°€ì ¸ì˜´
        const loc = $('#location').val(); // ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ loc ì‚¬ìš©
        const maxCapa = $('#maxCapa').val();

        // 2-2. ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
        if (!title || !rawDate || !loc) {
          alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        // Të¥¼ ê³µë°±(" ")ìœ¼ë¡œ ì¹˜í™˜
        const formattedDate = rawDate.replace('T', ' '); // "2026-02-07 19:00"

        // 2-3. ì „ì†¡ ë°ì´í„° êµ¬ì„±
        const sendData = {
          clubId: clubId,
          title: title,
          eventDate: formattedDate,
          location: loc,
          maxCapa: parseInt(maxCapa),
        };

        // 2-4. Ajax ìš”ì²­
        $.ajax({
          url: '/api/schedule/create',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(sendData),
          success: function (response) {
            alert('ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload();
          },
          error: function (err) {
            alert(
              'ë“±ë¡ ì‹¤íŒ¨: ' + (err.responseText || 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'),
            );
          },
        });
      }

      // 3. ì°¸ê°€ ì‹ ì²­ í•¨ìˆ˜
      function applySchedule(schedId) {
        if (!confirm('ì´ ì¼ì •ì— ì°¸ê°€ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        $.ajax({
          url: '/api/schedule/apply',
          type: 'POST',
          data: { schedId: schedId },
          success: function (response) {
            alert(response);
            loadSchedules(); // ì¸ì›ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          },
          error: function (err) {
            alert('ì‹ ì²­ ì‹¤íŒ¨: ' + err.responseText);
          },
        });
      }

      // 4. ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°)
      function openUpdateModal(item) {
        $('#updateSchedId').val(item.schedId);
        $('#updateTitle').val(item.title);
        // ë‚ ì§œ í˜•ì‹ ë§ì¶”ê¸° (ê³µë°±ì„ Të¡œ ì¹˜í™˜)
        $('#updateEventDate').val(item.eventDate.replace(' ', 'T'));
        $('#updateLocation').val(item.location);
        $('#updateMaxCapa').val(item.maxCapa);

        $('#updateScheduleModal').modal('show');
      }

      // 5. ì‹¤ì œ ìˆ˜ì • ìš”ì²­
      function updateSchedule() {
        const sendData = {
          schedId: $('#updateSchedId').val(),
          title: $('#updateTitle').val(),
          eventDate: $('#updateEventDate').val().replace('T', ' '),
          location: $('#updateLocation').val(),
          maxCapa: parseInt($('#updateMaxCapa').val()),
        };

        $.ajax({
          url: '/api/schedule/update',
          type: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(sendData),
          success: function (res) {
            alert(res);
            $('#updateScheduleModal').modal('hide');
            loadSchedules();
          },
          error: function (err) {
            alert(err.responseText);
          },
        });
      }

      // 6. ì‚­ì œ ìš”ì²­
      function deleteSchedule(schedId) {
        if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        $.ajax({
          url: '/api/schedule/delete',
          type: 'DELETE',
          data: { schedId: schedId },
          success: function (res) {
            alert(res);
            loadSchedules();
          },
          error: function (err) {
            alert(err.responseText);
          },
        });
      }

      // 7. ì°¸ì—¬ì ëª…ë‹¨ ì¡°íšŒ í•¨ìˆ˜
      function showParticipants(schedId) {
        $.ajax({
          url: '/api/schedule/participants',
          type: 'GET',
          data: { schedId: schedId },
          success: function (list) {
            let html = '';
            if (list.length === 0) {
              html =
                '<li class="list-group-item text-center py-4 text-muted">ì°¸ì—¬ìê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>';
            } else {
              list.forEach(function (p) {
                html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${p.memberName}</span> 
                                <span class="text-muted small">(${p.memberId})</span>
                            </div>
                            <span class="badge bg-success rounded-pill">ì°¸ê°€ì¤‘</span>
                        </li>`;
              });
            }
            $('#participantList').html(html);
            $('#participantModal').modal('show');
          },
          error: function (err) {
            alert('ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          },
        });
      }

      // 8. ì°¸ê°€ ì·¨ì†Œ í•¨ìˆ˜
      function cancelSchedule(schedId) {
        if (!confirm('ì •ë§ë¡œ ì°¸ê°€ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        $.ajax({
          url: '/api/schedule/cancel',
          type: 'POST',
          data: { schedId: schedId },
          success: function (res) {
            alert(res);
            loadSchedules(); // ë²„íŠ¼ ìƒíƒœë¥¼ ë°”ê¾¸ê¸° ìœ„í•´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          },
          error: function (err) {
            alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + err.responseText);
          },
        });
      }
    </script>
  </body>
</html>
